<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS & Email Alerts - NES Outage Checker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="shared-data.js"></script>
    <style>
        :root {
            --font-display: 'DM Serif Display', Georgia, serif;
            --font-body: 'Outfit', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
            --bg-primary: #1C1917;
            --bg-secondary: #292524;
            --bg-tertiary: #3D3936;
            --text-primary: #FAFAF9;
            --text-secondary: #A8A29E;
            --status-active: #10B981;
            --status-waiting: #F59E0B;
            --accent: #F97316;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; background: var(--bg-primary); color: var(--text-primary); font-family: var(--font-body); }

        header {
            background: var(--bg-secondary);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(168, 162, 158, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left { display: flex; gap: 2rem; align-items: center; }
        .nav-left h1 { font-family: var(--font-display); font-size: 1.8rem; color: var(--accent); }
        .nav-links { display: flex; gap: 1.5rem; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--text-secondary); font-size: 0.95rem; transition: color 0.2s; }
        .nav-links a:hover, .nav-links a.active { color: var(--accent); }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid rgba(168, 162, 158, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .card h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .card h3 {
            font-size: 1.1rem;
            margin: 1.5rem 0 1rem;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid rgba(168, 162, 158, 0.15);
            color: var(--text-primary);
            border-radius: 4px;
            font-family: var(--font-body);
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--status-active);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            font-family: var(--font-body);
            font-size: 0.95rem;
        }

        .btn:hover { background: #EA580C; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid rgba(168, 162, 158, 0.2);
        }

        .btn-secondary:hover { background: rgba(168, 162, 158, 0.2); }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.verified {
            background: rgba(16, 185, 129, 0.15);
            color: var(--status-active);
        }

        .status-badge.unverified {
            background: rgba(245, 158, 11, 0.15);
            color: var(--status-waiting);
        }

        .status-badge.disabled {
            background: rgba(168, 162, 158, 0.15);
            color: var(--text-secondary);
        }

        .info-box {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--status-active);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--status-waiting);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .success-msg {
            background: rgba(16, 185, 129, 0.15);
            color: var(--status-active);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .error-msg {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-item {
            background: var(--bg-tertiary);
            border: 1px solid rgba(168, 162, 158, 0.1);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .alert-info h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-details {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .alert-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .code-block {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            overflow-x: auto;
            margin: 1rem 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .area-checkboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .area-checkboxes {
                grid-template-columns: 1fr;
            }

            .alert-item {
                flex-direction: column;
            }

            .alert-actions {
                width: 100%;
                margin-top: 1rem;
            }

            body {
                padding-bottom: 70px;
            }

            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 70px;
                background: var(--bg-secondary);
                border-top: 1px solid rgba(168, 162, 158, 0.15);
                display: flex;
                justify-content: space-around;
                align-items: center;
                z-index: 99;
                box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                padding: 8px 12px;
                color: var(--text-secondary);
                text-decoration: none;
                font-size: 10px;
                font-weight: 500;
                transition: all 0.2s;
                cursor: pointer;
                border-radius: 8px;
                flex: 1;
                height: 100%;
            }

            .mobile-nav-item:hover {
                background: var(--bg-tertiary);
                color: var(--accent);
            }

            .mobile-nav-item.active {
                color: var(--accent);
                background: rgba(249, 115, 22, 0.15);
            }

            .mobile-nav-item-icon {
                font-size: 20px;
            }
        }

        @media (min-width: 769px) {
            .mobile-bottom-nav {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div class="nav-left">
                <h1>‚ö° NES Outage</h1>
                <ul class="nav-links">
                    <li><a href="index.html">Map</a></li>
                    <li><a href="all.html">All Outages</a></li>
                    <li><a href="stats.html">Analytics</a></li>
                    <li><a href="feed.html">Live Feed</a></li>
                    <li><a href="alerts-advanced.html" class="active">SMS & Email</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- SMS/Email Alerts Setup -->
        <div class="card">
            <h2>üì± SMS & Email Alerts</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Get instant notifications via SMS and email digests about outages in your area.</p>

            <div class="grid-2">
                <!-- SMS Setup -->
                <div>
                    <h3>üì≤ SMS Alerts</h3>
                    <div class="info-box">
                        Get real-time SMS alerts when outages occur in your area.
                    </div>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="smsPhone" placeholder="+1 (615) 555-0100" data-type="sms">
                    </div>

                    <div class="form-group">
                        <label>Mobile Carrier (for SMS setup)</label>
                        <select id="smsCarrier">
                            <option value="">Select carrier...</option>
                            <option value="ATT">AT&T</option>
                            <option value="TMOBILE">T-Mobile</option>
                            <option value="VERIZON">Verizon</option>
                            <option value="SPRINT">Sprint</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <div class="toggle-switch">
                        <label>SMS Enabled</label>
                        <label class="switch">
                            <input type="checkbox" id="smsEnabled">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="smsStatus" style="margin-bottom: 1rem;"></div>

                    <button class="btn btn-small" onclick="testSMS()">üß™ Send Test SMS</button>
                </div>

                <!-- Email Setup -->
                <div>
                    <h3>üìß Email Digests</h3>
                    <div class="info-box">
                        Receive daily, weekly, or monthly outage summaries.
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="emailAddr" placeholder="your@example.com" data-type="email">
                    </div>

                    <div class="form-group">
                        <label>Email Digest Frequency</label>
                        <div class="checkbox-group">
                            <input type="radio" id="emailDaily" name="emailFreq" value="daily" checked>
                            <label for="emailDaily">Daily (7 AM)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="radio" id="emailWeekly" name="emailFreq" value="weekly">
                            <label for="emailWeekly">Weekly (Monday 9 AM)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="radio" id="emailMonthly" name="emailFreq" value="monthly">
                            <label for="emailMonthly">Monthly (1st of month)</label>
                        </div>
                    </div>

                    <div id="emailStatus" style="margin-bottom: 1rem;"></div>

                    <button class="btn btn-small" onclick="testEmail()">üß™ Send Test Email</button>
                </div>
            </div>
        </div>

        <!-- Alert Preferences -->
        <div class="card">
            <h2>üîî Alert Preferences</h2>

            <h3>Alert Types</h3>
            <div class="info-box">
                Choose which types of events trigger alerts.
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="checkbox-group">
                    <input type="checkbox" id="alertNewOutage" checked>
                    <label for="alertNewOutage">üö® New Outages</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="alertResolved" checked>
                    <label for="alertResolved">‚úÖ Power Restored</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="alertCrewAssigned" checked>
                    <label for="alertCrewAssigned">üë∑ Crews Assigned</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="alertETAUpdate" checked>
                    <label for="alertETAUpdate">‚è±Ô∏è ETA Updates</label>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">Monitor Specific Areas</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Select which neighborhoods to track (leave blank to monitor all areas)</p>

            <div class="area-checkboxes">
                <div class="checkbox-group">
                    <input type="checkbox" id="area37201" class="alert-area">
                    <label for="area37201">Downtown/Capitol Hill (37201)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="area37202" class="alert-area">
                    <label for="area37202">North Nashville (37202)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="area37203" class="alert-area">
                    <label for="area37203">East Nashville (37203)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="area37205" class="alert-area">
                    <label for="area37205">Sylvan Park/West End (37205)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="area37206" class="alert-area">
                    <label for="area37206">Shelby Park/Weaver Park (37206)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="area37210" class="alert-area">
                    <label for="area37210">Antioch (37210)</label>
                </div>
            </div>

            <button class="btn" onclick="savePreferences()" style="margin-top: 1.5rem;">üíæ Save Preferences</button>
            <div id="saveMsg" style="margin-top: 1rem;"></div>
        </div>

        <!-- Recent Alerts Log -->
        <div class="card">
            <h2>üìã Recent Alerts Log</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Last 20 test alerts and actual notifications</p>
            <div id="recentAlerts">
                <div style="color: var(--text-secondary); padding: 2rem; text-align: center;">No alerts yet. Send a test alert to see logs here.</div>
            </div>
            <button class="btn btn-secondary" onclick="clearAlertLog()" style="margin-top: 1rem;">üóëÔ∏è Clear Log</button>
        </div>

        <!-- Unsubscribe Section -->
        <div class="card" style="background: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.2);">
            <h2>‚ö†Ô∏è Danger Zone</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">This action will clear all alert preferences and contact information from your device.</p>
            <button class="btn" style="background: #EF4444;" onclick="unsubscribeAll()">üö´ Unsubscribe & Clear All</button>
        </div>
    </div>

    <script>
        const PREFS_KEY = 'nes-alert-prefs';
        const ALERTS_KEY = 'nes-recent-alerts';

        // Load preferences on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadPreferences();
            renderRecentAlerts();
            updateStatusBadges();
        });

        function loadPreferences() {
            const prefs = JSON.parse(localStorage.getItem(PREFS_KEY) || '{}');
            
            if (prefs.smsPhone) {
                document.getElementById('smsPhone').value = prefs.smsPhone;
                document.getElementById('smsCarrier').value = prefs.smsCarrier || '';
                document.getElementById('smsEnabled').checked = prefs.smsEnabled !== false;
            }
            
            if (prefs.email) {
                document.getElementById('emailAddr').value = prefs.email;
                document.getElementById('email' + (prefs.emailFreq || 'Daily')).checked = true;
            }

            if (prefs.alertTypes) {
                document.getElementById('alertNewOutage').checked = prefs.alertTypes.newOutage !== false;
                document.getElementById('alertResolved').checked = prefs.alertTypes.resolved !== false;
                document.getElementById('alertCrewAssigned').checked = prefs.alertTypes.crewAssigned !== false;
                document.getElementById('alertETAUpdate').checked = prefs.alertTypes.etaUpdate !== false;
            }

            if (prefs.monitoredAreas && Array.isArray(prefs.monitoredAreas)) {
                prefs.monitoredAreas.forEach(area => {
                    const checkbox = document.getElementById('area' + area);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        function savePreferences() {
            const prefs = {
                smsPhone: document.getElementById('smsPhone').value,
                smsCarrier: document.getElementById('smsCarrier').value,
                smsEnabled: document.getElementById('smsEnabled').checked,
                email: document.getElementById('emailAddr').value,
                emailFreq: document.querySelector('input[name="emailFreq"]:checked').value,
                alertTypes: {
                    newOutage: document.getElementById('alertNewOutage').checked,
                    resolved: document.getElementById('alertResolved').checked,
                    crewAssigned: document.getElementById('alertCrewAssigned').checked,
                    etaUpdate: document.getElementById('alertETAUpdate').checked
                },
                monitoredAreas: Array.from(document.querySelectorAll('.alert-area:checked')).map(cb => cb.id.replace('area', '')),
                savedAt: new Date().toISOString()
            };

            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
            document.getElementById('saveMsg').innerHTML = '<div class="success-msg">‚úÖ Preferences saved successfully!</div>';
            setTimeout(() => { document.getElementById('saveMsg').innerHTML = ''; }, 3000);
            updateStatusBadges();
        }

        function updateStatusBadges() {
            const prefs = JSON.parse(localStorage.getItem(PREFS_KEY) || '{}');
            const smsStatus = document.getElementById('smsStatus');
            const emailStatus = document.getElementById('emailStatus');

            if (prefs.smsEnabled && prefs.smsPhone) {
                smsStatus.innerHTML = '<div class="status-badge verified">‚úÖ SMS ready (phone verified)</div>';
            } else if (prefs.smsPhone) {
                smsStatus.innerHTML = '<div class="status-badge unverified">‚è≥ SMS pending verification</div>';
            } else {
                smsStatus.innerHTML = '<div class="status-badge disabled">‚ùå SMS disabled</div>';
            }

            if (prefs.email) {
                emailStatus.innerHTML = '<div class="status-badge verified">‚úÖ Email configured</div>';
            } else {
                emailStatus.innerHTML = '<div class="status-badge disabled">‚ùå Email not configured</div>';
            }
        }

        function testSMS() {
            const phone = document.getElementById('smsPhone').value;
            const carrier = document.getElementById('smsCarrier').value;

            if (!phone) {
                alert('‚ùå Please enter a phone number first');
                return;
            }

            const result = sendTestAlert(phone, carrier);
            alert(`‚úÖ ${result.message}\n\nCheck console (F12) for backend payload details`);
            renderRecentAlerts();
        }

        function testEmail() {
            const email = document.getElementById('emailAddr').value;
            const freq = document.querySelector('input[name="emailFreq"]:checked').value;

            if (!email) {
                alert('‚ùå Please enter an email address first');
                return;
            }

            const result = sendTestEmail(email, freq);
            alert(`‚úÖ ${result.message}\n\nCheck console (F12) for email content details`);
            renderRecentAlerts();
        }

        function renderRecentAlerts() {
            const alerts = JSON.parse(localStorage.getItem(ALERTS_KEY) || '[]');
            const container = document.getElementById('recentAlerts');

            if (alerts.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); padding: 2rem; text-align: center;">No alerts yet. Send a test alert to see logs here.</div>';
                return;
            }

            container.innerHTML = alerts.slice(0, 20).map(alert => {
                const date = new Date(alert.timestamp);
                const timeStr = date.toLocaleTimeString();
                const dateStr = date.toLocaleDateString();

                let icon = 'üì±';
                let details = alert.phoneNumber;
                if (alert.type === 'email') {
                    icon = 'üìß';
                    details = `${alert.email} (${alert.digestType})`;
                }

                return `
                    <div class="alert-item">
                        <div class="alert-info">
                            <h4>${icon} ${alert.type.toUpperCase()} - ${alert.status}</h4>
                            <div class="alert-details">
                                ${alert.message || alert.subject || details}<br>
                                <small>${dateStr} at ${timeStr}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearAlertLog() {
            if (confirm('Clear all alert logs?')) {
                localStorage.removeItem(ALERTS_KEY);
                renderRecentAlerts();
            }
        }

        function unsubscribeAll() {
            if (confirm('‚ö†Ô∏è This will delete all your alert preferences and contact information. Are you sure?')) {
                if (confirm('üö® This action cannot be undone. Continue?')) {
                    localStorage.removeItem(PREFS_KEY);
                    localStorage.removeItem(ALERTS_KEY);
                    location.reload();
                }
            }
        }

        // Console logging for backend integration
        console.log('%cüì± NES SMS/Email Alert System Ready', 'color: #10B981; font-size: 16px; font-weight: bold;');
        console.log('%cFor production:', 'color: #F59E0B; font-weight: bold;');
        console.log('1. Replace sendTestAlert() calls with actual Twilio API calls');
        console.log('2. Replace sendTestEmail() calls with SendGrid/SES integration');
        console.log('3. Implement backend persistence for preferences');
        console.log('4. Add phone number verification workflow');
        console.log('\nOpen browser console (F12) and send test alerts to see Twilio payloads');
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <a href="index.html" class="mobile-nav-item" title="Monitor">
            <span class="mobile-nav-item-icon">üè†</span>
            <span class="mobile-nav-item-label">Monitor</span>
        </a>
        <a href="all.html" class="mobile-nav-item" title="All Outages">
            <span class="mobile-nav-item-icon">üìä</span>
            <span class="mobile-nav-item-label">Outages</span>
        </a>
        <a href="stats.html" class="mobile-nav-item" title="Statistics">
            <span class="mobile-nav-item-icon">üìà</span>
            <span class="mobile-nav-item-label">Stats</span>
        </a>
        <a href="feed.html" class="mobile-nav-item" title="Feed">
            <span class="mobile-nav-item-icon">üéÆ</span>
            <span class="mobile-nav-item-label">Feed</span>
        </a>
        <a href="alerts-advanced.html" class="mobile-nav-item active" title="Alerts">
            <span class="mobile-nav-item-icon">‚öôÔ∏è</span>
            <span class="mobile-nav-item-label">Alerts</span>
        </a>
    </nav>

    <!-- Command Palette and Geofence -->
    <script src="command-palette.js"></script>
    <script src="geofence.js"></script>
</body>
</html>
